-- =====================================================
-- BANCO DE DADOS COMPLETO - SISTEMA ACADÊMICO TCC
-- =====================================================


-- Criar banco de dados se não existir
CREATE DATABASE IF NOT EXISTS `bd_tcc`
CHARACTER SET utf8mb4
COLLATE utf8mb4_unicode_ci;

-- Usar o banco de dados
USE `bd_tcc`;

-- =====================================================
-- TABELA PRINCIPAL: USUÁRIOS
-- =====================================================
CREATE TABLE IF NOT EXISTS `usuarios` (
  `id` INT NOT NULL AUTO_INCREMENT COMMENT 'Chave primária e auto incremento',
  `nome_user` VARCHAR(150) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'Nome completo do usuário',
  `cpf_user` CHAR(11) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'CPF apenas números',
  `email_user` VARCHAR(150) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'E-mail único do usuário',
  `telefone_user` VARCHAR(15) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT 'Telefone com DDD',
  `senha_user` VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'Senha com hash',
  `tipo_usuario` ENUM('Professor','Administrador') CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'Tipo de acesso do usuário',
  `data_criacao` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Data de criação do registro',
  `data_atualizacao` DATETIME NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT 'Última atualização',
  `status` ENUM('ativo','inativo') CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT 'ativo' COMMENT 'Status do usuário',
  `ultimo_login` DATETIME NULL DEFAULT NULL COMMENT 'Data do último login',
  PRIMARY KEY (`id`),
  UNIQUE KEY `email_user_UNIQUE` (`email_user`),
  UNIQUE KEY `cpf_user_UNIQUE` (`cpf_user`),
  INDEX `idx_tipo_usuario` (`tipo_usuario`),
  INDEX `idx_status` (`status`),
  INDEX `idx_data_criacao` (`data_criacao`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Tabela principal de usuários do sistema';

-- =====================================================
-- TABELA: MATÉRIAS/DISCIPLINAS
-- =====================================================
CREATE TABLE IF NOT EXISTS `materias` (
  `id_materia` INT NOT NULL AUTO_INCREMENT COMMENT 'Identificador único da matéria',
  `nome_materia` VARCHAR(150) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'Nome da matéria',
  `codigo_materia` VARCHAR(20) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT 'Código da matéria',
  `carga_horaria` INT NOT NULL DEFAULT 0 COMMENT 'Carga horária em horas',
  `descricao` TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT 'Descrição detalhada',
  `categoria` ENUM('obrigatoria','optativa','eletiva') CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT 'obrigatoria' COMMENT 'Categoria da matéria',
  `status` ENUM('ativa','inativa') CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT 'ativa' COMMENT 'Status da matéria',
  `data_criacao` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `data_atualizacao` DATETIME NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
  `id_usuario_criador` INT NULL DEFAULT NULL COMMENT 'Professor responsável',
  PRIMARY KEY (`id_materia`),
  UNIQUE KEY `codigo_materia_UNIQUE` (`codigo_materia`),
  INDEX `idx_categoria` (`categoria`),
  INDEX `idx_status` (`status`),
  INDEX `idx_id_usuario_criador` (`id_usuario_criador`),
  FOREIGN KEY (`id_usuario_criador`) REFERENCES `usuarios`(`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Tabela de matérias/disciplinas';

-- =====================================================
-- TABELA: PERFIS DOS USUÁRIOS (EXTENSÃO)
-- =====================================================
CREATE TABLE IF NOT EXISTS `perfis_usuario` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `id_usuario` INT NOT NULL UNIQUE COMMENT 'ID do usuário (relação 1:1)',
  `foto_perfil` VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT 'Caminho da foto de perfil',
  `biografia` TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT 'Biografia do usuário',
  `especialidade` VARCHAR(150) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT 'Especialidade (para professores)',
  `formacao` VARCHAR(200) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT 'Formação acadêmica',
  `linkedin` VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT 'Perfil do LinkedIn',
  `site_pessoal` VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT 'Site pessoal ou portfólio',
  `data_nascimento` DATE NULL DEFAULT NULL COMMENT 'Data de nascimento',
  `endereco` TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT 'Endereço completo',
  `atualizado_em` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  INDEX `idx_id_usuario` (`id_usuario`),
  FOREIGN KEY (`id_usuario`) REFERENCES `usuarios`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Dados estendidos do perfil do usuário';

-- =====================================================
-- TABELA: RECUPERAÇÃO DE SENHA
-- =====================================================
CREATE TABLE IF NOT EXISTS `recuperacao_senha` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `id_usuario` INT NOT NULL COMMENT 'ID do usuário solicitante',
  `token` VARCHAR(64) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'Token único para redefinição',
  `expiracao` DATETIME NOT NULL COMMENT 'Data e hora de expiração do token',
  `utilizado` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '0=Não utilizado, 1=Utilizado',
  `ip_solicitante` VARCHAR(45) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT 'IP que solicitou a recuperação',
  `criado_em` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Data de criação',
  `utilizado_em` DATETIME NULL DEFAULT NULL COMMENT 'Data quando foi utilizado',
  PRIMARY KEY (`id`),
  INDEX `idx_token` (`token`),
  INDEX `idx_expiracao` (`expiracao`),
  INDEX `idx_id_usuario` (`id_usuario`),
  INDEX `idx_utilizado` (`utilizado`),
  FOREIGN KEY (`id_usuario`) REFERENCES `usuarios`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Tokens de recuperação de senha';

-- =====================================================
-- TABELA: VÍNCULO USUÁRIO-MATÉRIA
-- =====================================================
CREATE TABLE IF NOT EXISTS `usuario_materia` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `id_usuario` INT NOT NULL COMMENT 'ID do professor',
  `id_materia` INT NOT NULL COMMENT 'ID da matéria',
  `ano` YEAR NOT NULL COMMENT 'Ano de vínculo',
  `semestre` TINYINT NOT NULL DEFAULT 1 COMMENT 'Semestre (1 ou 2)',
  `status` ENUM('ativo','inativo') NOT NULL DEFAULT 'ativo' COMMENT 'Status do vínculo',
  `data_vinculo` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Data do vínculo',
  PRIMARY KEY (`id`),
  UNIQUE KEY `usuario_materia_ano_semestre_UNIQUE` (`id_usuario`, `id_materia`, `ano`, `semestre`),
  INDEX `idx_id_usuario` (`id_usuario`),
  INDEX `idx_id_materia` (`id_materia`),
  INDEX `idx_ano` (`ano`),
  INDEX `idx_semestre` (`semestre`),
  FOREIGN KEY (`id_usuario`) REFERENCES `usuarios`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`id_materia`) REFERENCES `materias`(`id_materia`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Vínculo entre professores e matérias';

-- =====================================================
-- TABELA: AULAS
-- =====================================================
CREATE TABLE IF NOT EXISTS `aulas` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `id_materia` INT NOT NULL COMMENT 'ID da matéria',
  `id_professor` INT NOT NULL COMMENT 'ID do professor',
  `titulo` VARCHAR(200) NOT NULL COMMENT 'Título da aula',
  `descricao` TEXT NULL DEFAULT NULL COMMENT 'Descrição/conteúdo da aula',
  `data_aula` DATE NOT NULL COMMENT 'Data da aula',
  `hora_inicio` TIME NOT NULL COMMENT 'Hora de início',
  `hora_fim` TIME NOT NULL COMMENT 'Hora de término',
  `sala` VARCHAR(50) NULL DEFAULT NULL COMMENT 'Sala da aula',
  `tipo_aula` ENUM('teorica','pratica','laboratorio','online') NOT NULL DEFAULT 'teorica' COMMENT 'Tipo de aula',
  `status` ENUM('planejada','realizada','cancelada','adiada') NOT NULL DEFAULT 'planejada' COMMENT 'Status da aula',
  `arquivo_material` VARCHAR(255) NULL DEFAULT NULL COMMENT 'Caminho do arquivo/material da aula',
  `link_aula` VARCHAR(255) NULL DEFAULT NULL COMMENT 'Link para aula online',
  `observacoes` TEXT NULL DEFAULT NULL COMMENT 'Observações adicionais',
  `data_criacao` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `data_atualizacao` DATETIME NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  INDEX `idx_id_materia` (`id_materia`),
  INDEX `idx_id_professor` (`id_professor`),
  INDEX `idx_data_aula` (`data_aula`),
  INDEX `idx_status` (`status`),
  INDEX `idx_tipo_aula` (`tipo_aula`),
  FOREIGN KEY (`id_materia`) REFERENCES `materias`(`id_materia`) ON DELETE CASCADE,
  FOREIGN KEY (`id_professor`) REFERENCES `usuarios`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Agendamento das aulas';

-- =====================================================
-- TABELA: LOGS DE ATIVIDADES
-- =====================================================
CREATE TABLE IF NOT EXISTS `logs_atividades` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `id_usuario` INT NOT NULL COMMENT 'ID do usuário que realizou a ação',
  `acao` VARCHAR(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'Tipo de ação',
  `descricao` TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT 'Descrição detalhada',
  `tabela_afetada` VARCHAR(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT 'Tabela afetada pela ação',
  `id_registro_afetado` INT NULL DEFAULT NULL COMMENT 'ID do registro afetado',
  `ip_address` VARCHAR(45) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT 'Endereço IP do usuário',
  `user_agent` TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT 'Informações do navegador',
  `data_hora` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Data e hora da atividade',
  PRIMARY KEY (`id`),
  INDEX `idx_usuario` (`id_usuario`),
  INDEX `idx_acao` (`acao`),
  INDEX `idx_data_hora` (`data_hora`),
  INDEX `idx_tabela_afetada` (`tabela_afetada`),
  INDEX `idx_ip_address` (`ip_address`),
  FOREIGN KEY (`id_usuario`) REFERENCES `usuarios`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Registro de auditoria de atividades';

-- =====================================================
-- TABELA: EVENTOS DO CALENDÁRIO
-- =====================================================
CREATE TABLE IF NOT EXISTS `eventos_calendario` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `id_usuario_criador` INT NOT NULL COMMENT 'ID do usuário que criou o evento',
  `titulo` VARCHAR(200) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'Título do evento',
  `descricao` TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT 'Descrição do evento',
  `data_inicio` DATETIME NOT NULL COMMENT 'Data e hora de início',
  `data_fim` DATETIME NULL DEFAULT NULL COMMENT 'Data e hora de término',
  `tipo_evento` ENUM('prova','trabalho','reuniao','aula','evento','feriado','outro') CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT 'outro',
  `cor` VARCHAR(7) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT '#007bff' COMMENT 'Cor em hexadecimal',
  `local` VARCHAR(200) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT 'Local do evento',
  `todo_dia` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '0=Evento normal, 1=Evento dia todo',
  `recorrente` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '0=Não recorrente, 1=Recorrente',
  `status` ENUM('ativo','cancelado','concluido') CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT 'ativo' COMMENT 'Status do evento',
  `criado_em` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `atualizado_em` DATETIME NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  INDEX `idx_usuario_criador` (`id_usuario_criador`),
  INDEX `idx_data_inicio` (`data_inicio`),
  INDEX `idx_data_fim` (`data_fim`),
  INDEX `idx_tipo_evento` (`tipo_evento`),
  INDEX `idx_status` (`status`),
  INDEX `idx_todo_dia` (`todo_dia`),
  FOREIGN KEY (`id_usuario_criador`) REFERENCES `usuarios`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Eventos do calendário acadêmico';

-- =====================================================
-- TABELA: PARTICIPANTES DE EVENTOS
-- =====================================================
CREATE TABLE IF NOT EXISTS `evento_participantes` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `id_evento` INT NOT NULL COMMENT 'ID do evento',
  `id_usuario` INT NOT NULL COMMENT 'ID do participante',
  `status_participacao` ENUM('confirmado','pendente','recusado') CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT 'pendente' COMMENT 'Status da participação',
  `data_resposta` DATETIME NULL DEFAULT NULL COMMENT 'Data da resposta do convite',
  `observacoes` TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT 'Observações do participante',
  `convidado_em` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Data do convite',
  PRIMARY KEY (`id`),
  UNIQUE KEY `evento_usuario_UNIQUE` (`id_evento`, `id_usuario`),
  INDEX `idx_id_evento` (`id_evento`),
  INDEX `idx_id_usuario` (`id_usuario`),
  INDEX `idx_status_participacao` (`status_participacao`),
  FOREIGN KEY (`id_evento`) REFERENCES `eventos_calendario`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`id_usuario`) REFERENCES `usuarios`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Participantes dos eventos';

-- =====================================================
-- TABELA: NOTIFICAÇÕES
-- =====================================================
CREATE TABLE IF NOT EXISTS `notificacoes` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `id_usuario_destino` INT NOT NULL COMMENT 'ID do usuário que receberá a notificação',
  `id_usuario_remetente` INT NULL DEFAULT NULL COMMENT 'ID do usuário que enviou (NULL para sistema)',
  `titulo` VARCHAR(200) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'Título da notificação',
  `mensagem` TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'Mensagem da notificação',
  `tipo` ENUM('info','sucesso','aviso','erro') CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT 'info',
  `categoria` ENUM('sistema','evento','usuario','backup','seguranca') CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT 'sistema',
  `lida` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '0=Não lida, 1=Lida',
  `importancia` ENUM('baixa','media','alta','urgente') CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT 'media',
  `data_criacao` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `data_leitura` DATETIME NULL DEFAULT NULL COMMENT 'Data quando foi lida',
  `data_expiracao` DATETIME NULL DEFAULT NULL COMMENT 'Data de expiração (opcional)',
  `url_acao` VARCHAR(500) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT 'URL para ação relacionada',
  PRIMARY KEY (`id`),
  INDEX `idx_usuario_destino` (`id_usuario_destino`),
  INDEX `idx_usuario_remetente` (`id_usuario_remetente`),
  INDEX `idx_lida` (`lida`),
  INDEX `idx_data_criacao` (`data_criacao`),
  INDEX `idx_tipo` (`tipo`),
  INDEX `idx_categoria` (`categoria`),
  INDEX `idx_importancia` (`importancia`),
  INDEX `idx_data_expiracao` (`data_expiracao`),
  FOREIGN KEY (`id_usuario_destino`) REFERENCES `usuarios`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`id_usuario_remetente`) REFERENCES `usuarios`(`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Sistema de notificações';

-- =====================================================
-- TABELA: RELAÇÃO USUÁRIO-MATÉRIA
-- =====================================================
CREATE TABLE IF NOT EXISTS `usuario_materia` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `id_usuario` INT NOT NULL COMMENT 'ID do professor',
  `id_materia` INT NOT NULL COMMENT 'ID da matéria',
  `funcao` ENUM('professor','monitor','coordenador') CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT 'professor' COMMENT 'Função do usuário na matéria',
  `status` ENUM('ativo','inativo') CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT 'ativo' COMMENT 'Status da relação',
  `data_inicio` DATE NOT NULL COMMENT 'Data de início na matéria',
  `data_fim` DATE NULL DEFAULT NULL COMMENT 'Data de fim na matéria',
  `observacoes` TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT 'Observações',
  `criado_em` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `usuario_materia_UNIQUE` (`id_usuario`, `id_materia`),
  INDEX `idx_id_usuario` (`id_usuario`),
  INDEX `idx_id_materia` (`id_materia`),
  INDEX `idx_funcao` (`funcao`),
  INDEX `idx_status` (`status`),
  FOREIGN KEY (`id_usuario`) REFERENCES `usuarios`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`id_materia`) REFERENCES `materias`(`id_materia`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Relação entre usuários e matérias';

-- =====================================================
-- TABELA: CONFIGURAÇÕES DO SISTEMA
-- =====================================================
CREATE TABLE IF NOT EXISTS `configuracoes_sistema` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `chave` VARCHAR(100) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'Chave da configuração',
  `valor` TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT 'Valor da configuração',
  `descricao` TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT 'Descrição da configuração',
  `tipo` ENUM('string','numero','boolean','json') CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT 'string' COMMENT 'Tipo do valor',
  `categoria` VARCHAR(50) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT 'geral' COMMENT 'Categoria da configuração',
  `editavel` TINYINT(1) NOT NULL DEFAULT 1 COMMENT 'Pode ser editada via interface',
  `atualizado_por` INT NULL DEFAULT NULL COMMENT 'Último usuário que atualizou',
  `atualizado_em` DATETIME NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `chave_UNIQUE` (`chave`),
  INDEX `idx_categoria` (`categoria`),
  INDEX `idx_editavel` (`editavel`),
  FOREIGN KEY (`atualizado_por`) REFERENCES `usuarios`(`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Configurações globais do sistema';

-- =====================================================
-- TABELA: SESSÕES ATIVAS
-- =====================================================
CREATE TABLE IF NOT EXISTS `sessoes_ativas` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `id_usuario` INT NOT NULL COMMENT 'ID do usuário',
  `session_id` VARCHAR(255) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'ID da sessão PHP',
  `ip_address` VARCHAR(45) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL COMMENT 'IP da sessão',
  `user_agent` TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NULL DEFAULT NULL COMMENT 'User agent',
  `data_inicio` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Início da sessão',
  `data_ultima_atividade` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Última atividade',
  `status` ENUM('ativa','expirada','logout') CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci NOT NULL DEFAULT 'ativa',
  PRIMARY KEY (`id`),
  INDEX `idx_id_usuario` (`id_usuario`),
  INDEX `idx_session_id` (`session_id`),
  INDEX `idx_ip_address` (`ip_address`),
  INDEX `idx_data_ultima_atividade` (`data_ultima_atividade`),
  INDEX `idx_status` (`status`),
  FOREIGN KEY (`id_usuario`) REFERENCES `usuarios`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Controle de sessões ativas';

-- =====================================================
-- INSERÇÕES INICIAIS (CONFIGURAÇÕES)
-- =====================================================

-- Configurações padrão do sistema
INSERT IGNORE INTO `configuracoes_sistema` (`chave`, `valor`, `descricao`, `tipo`, `categoria`) VALUES
('nome_sistema', 'Sistema Acadêmico TCC', 'Nome do sistema exibido na interface', 'string', 'geral'),
('versao_sistema', '1.0.0', 'Versão atual do sistema', 'string', 'geral'),
('email_contato', 'admin@sistema.com', 'E-mail de contato do sistema', 'string', 'geral'),
('max_tentativas_login', '5', 'Número máximo de tentativas de login', 'numero', 'seguranca'),
('tempo_sessao', '7200', 'Tempo de sessão em segundos (2 horas)', 'numero', 'seguranca'),
('backup_automatico', '1', 'Ativar backup automático diário', 'boolean', 'backup'),
('manter_logs_dias', '90', 'Dias para manter logs de atividades', 'numero', 'logs'),
('notificar_eventos', '1', 'Enviar notificações de novos eventos', 'boolean', 'notificacoes'),
('cor_padrao_eventos', '#007bff', 'Cor padrão para novos eventos', 'string', 'calendario');

-- =====================================================
-- VIEWS (VISÕES ÚTEIS)
-- =====================================================

-- View para estatísticas de usuários
CREATE OR REPLACE VIEW `v_estatisticas_usuarios` AS
SELECT
    tipo_usuario,
    COUNT(*) as total,
    COUNT(CASE WHEN status = 'ativo' THEN 1 END) as ativos,
    COUNT(CASE WHEN status = 'inativo' THEN 1 END) as inativos,
    DATE(data_criacao) as data_criacao
FROM usuarios
GROUP BY tipo_usuario, DATE(data_criacao);

-- View para eventos do mês
CREATE OR REPLACE VIEW `v_eventos_mes` AS
SELECT
    ec.*,
    u.nome_user as criador_nome,
    YEAR(ec.data_inicio) as ano,
    MONTH(ec.data_inicio) as mes,
    DAY(ec.data_inicio) as dia
FROM eventos_calendario ec
JOIN usuarios u ON ec.id_usuario_criador = u.id
WHERE ec.status = 'ativo'
AND ec.data_inicio >= DATE_FORMAT(NOW(), '%Y-%m-01')
AND ec.data_inicio < DATE_FORMAT(NOW() + INTERVAL 1 MONTH, '%Y-%m-01');

-- View para notificações não lidas
CREATE OR REPLACE VIEW `v_notificacoes_nao_lidas` AS
SELECT
    n.*,
    u_remetente.nome_user as remetente_nome,
    TIMESTAMPDIFF(MINUTE, n.data_criacao, NOW()) as minutos_criacao
FROM notificacoes n
LEFT JOIN usuarios u_remetente ON n.id_usuario_remetente = u_remetente.id
WHERE n.lida = 0
AND (n.data_expiracao IS NULL OR n.data_expiracao > NOW())
ORDER BY n.importancia DESC, n.data_criacao DESC;

-- =====================================================
-- TRIGGERS (GATILHOS AUTOMÁTICOS)
-- =====================================================

-- Trigger para registrar logs de alterações
DELIMITER //
CREATE TRIGGER `tr_log_usuario_insert`
AFTER INSERT ON `usuarios`
FOR EACH ROW
BEGIN
    INSERT INTO logs_atividades (id_usuario, acao, descricao, tabela_afetada, id_registro_afetado)
    VALUES (NEW.id, 'cadastro', CONCAT('Novo usuário cadastrado: ', NEW.nome_user), 'usuarios', NEW.id);
END//

CREATE TRIGGER `tr_log_usuario_update`
AFTER UPDATE ON `usuarios`
FOR EACH ROW
BEGIN
    IF NEW.nome_user != OLD.nome_user OR NEW.email_user != OLD.email_user OR NEW.tipo_usuario != OLD.tipo_usuario THEN
        INSERT INTO logs_atividades (id_usuario, acao, descricao, tabela_afetada, id_registro_afetado)
        VALUES (NEW.id, 'atualizacao', CONCAT('Dados do usuário atualizados: ', NEW.nome_user), 'usuarios', NEW.id);
    END IF;
END//

CREATE TRIGGER `tr_log_usuario_delete`
BEFORE DELETE ON `usuarios`
FOR EACH ROW
BEGIN
    INSERT INTO logs_atividades (id_usuario, acao, descricao, tabela_afetada, id_registro_afetado)
    VALUES (OLD.id, 'exclusao', CONCAT('Usuário excluído: ', OLD.nome_user), 'usuarios', OLD.id);
END//

CREATE TRIGGER `tr_log_evento_insert`
AFTER INSERT ON `eventos_calendario`
FOR EACH ROW
BEGIN
    INSERT INTO logs_atividades (id_usuario, acao, descricao, tabela_afetada, id_registro_afetado)
    VALUES (NEW.id_usuario_criador, 'criacao_evento', CONCAT('Evento criado: ', NEW.titulo), 'eventos_calendario', NEW.id);
END//
DELIMITER ;

-- =====================================================
-- STORED PROCEDURES (PROCEDIMENTOS ARMAZENADOS)
-- =====================================================

DELIMITER //
CREATE PROCEDURE `sp_limpar_logs_antigos`(IN dias_manter INT)
BEGIN
    DELETE FROM logs_atividades
    WHERE data_hora < DATE_SUB(NOW(), INTERVAL dias_manter DAY);

    SELECT ROW_COUNT() as logs_excluidos;
END//

CREATE PROCEDURE `sp_estatisticas_dashboard`()
BEGIN
    SELECT
        (SELECT COUNT(*) FROM usuarios WHERE status = 'ativo') as total_usuarios_ativos,
        (SELECT COUNT(*) FROM usuarios WHERE tipo_usuario = 'Administrador' AND status = 'ativo') as total_administradores,
        (SELECT COUNT(*) FROM usuarios WHERE tipo_usuario = 'Professor' AND status = 'ativo') as total_professores,
        (SELECT COUNT(*) FROM materias WHERE status = 'ativa') as total_materias_ativas,
        (SELECT COUNT(*) FROM eventos_calendario
         WHERE MONTH(data_inicio) = MONTH(NOW())
         AND YEAR(data_inicio) = YEAR(NOW())
         AND status = 'ativo') as eventos_mes_atual,
        (SELECT COUNT(*) FROM notificacoes WHERE lida = 0) as notificacoes_nao_lidas,
        (SELECT COUNT(*) FROM logs_atividades WHERE DATE(data_hora) = CURDATE()) as atividades_hoje;
END//

CREATE PROCEDURE `sp_buscar_usuarios_avancado`(
    IN termo_busca VARCHAR(255),
    IN tipo_filtro VARCHAR(50),
    IN status_filtro VARCHAR(20),
    IN limite INT,
    IN offset_param INT
)
BEGIN
    SELECT
        u.id,
        u.nome_user,
        u.email_user,
        u.cpf_user,
        u.telefone_user,
        u.tipo_usuario,
        u.status,
        u.data_criacao,
        u.ultimo_login,
        pu.foto_perfil,
        pu.especialidade
    FROM usuarios u
    LEFT JOIN perfis_usuario pu ON u.id = pu.id_usuario
    WHERE (u.nome_user LIKE CONCAT('%', termo_busca, '%')
           OR u.email_user LIKE CONCAT('%', termo_busca, '%')
           OR u.cpf_user LIKE CONCAT('%', termo_busca, '%'))
    AND (tipo_filtro IS NULL OR u.tipo_usuario = tipo_filtro)
    AND (status_filtro IS NULL OR u.status = status_filtro)
    ORDER BY u.nome_user
    LIMIT limite OFFSET offset_param;
END//
DELIMITER ;

-- =====================================================
-- ÍNDICES ADICIONAIS PARA PERFORMANCE
-- =====================================================

-- Índices compostos para consultas frequentes
CREATE INDEX IF NOT EXISTS `idx_usuario_status_tipo` ON `usuarios` (`status`, `tipo_usuario`);
CREATE INDEX IF NOT EXISTS `idx_evento_data_status` ON `eventos_calendario` (`data_inicio`, `status`);
CREATE INDEX IF NOT EXISTS `idx_notificacao_destino_lida` ON `notificacoes` (`id_usuario_destino`, `lida`);
CREATE INDEX IF NOT EXISTS `idx_logs_usuario_data` ON `logs_atividades` (`id_usuario`, `data_hora`);
CREATE INDEX IF NOT EXISTS `idx_recuperacao_usuario_expiracao` ON `recuperacao_senha` (`id_usuario`, `expiracao`);

-- =====================================================
-- RELATÓRIO FINAL
-- =====================================================
SELECT 'Banco de dados criado com sucesso!' as mensagem,
       NOW() as data_criacao,
       VERSION() as versao_mysql,
       DATABASE() as banco_selecionado;